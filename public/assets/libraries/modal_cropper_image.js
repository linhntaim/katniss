function CropImageModal(t,e,i){this.$container=t,this.$cropperImageView=this.$container.find(".cropper-image-view"),this.$cropperImage=this.$cropperImageView.is("img")?this.$cropperImageView:$(this.$cropperImageView.attr("data-img")),this.$cropperImageModal=this.$container.find("#cropper-image-modal"),this.$loading=this.$container.find(".cropper-image-loading"),this.$cropperImageForm=this.$cropperImageModal.find(".cropper-image-form"),this.$cropperImageUpload=this.$cropperImageForm.find(".cropper-image-upload"),this.$cropperImageSrc=this.$cropperImageForm.find(".cropper-image-src"),this.$cropperImageData=this.$cropperImageForm.find(".cropper-image-data"),this.$cropperImageInput=this.$cropperImageForm.find(".cropper-image-input"),this.$cropperImageSave=this.$cropperImageForm.find(".cropper-image-save"),this.$cropperImageButtons=this.$cropperImageForm.find(".cropper-image-buttons button"),this.$cropperImageWrapper=this.$cropperImageModal.find(".cropper-image-wrapper"),this.$cropperImagePreview=this.$cropperImageModal.find(".cropper-image-preview"),this.aspectRatio=e,this.postUrl=i,this.init()}CropImageModal.prototype={constructor:CropImageModal,support:{fileList:!!$('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.initTooltip(),this.initModal(),this.addListener()},addListener:function(){this.$cropperImageView.on("click",$.proxy(this.click,this)),this.$cropperImageInput.on("change",$.proxy(this.change,this)),this.$cropperImageForm.on("submit",$.proxy(this.submit,this)),this.$cropperImageButtons.on("click",$.proxy(this.rotate,this))},initTooltip:function(){this.$cropperImageView.tooltip({placement:"bottom"})},initModal:function(){this.$cropperImageModal.modal({show:!1})},initPreview:function(){var t=this.$cropperImage.attr("src");this.$cropperImagePreview.html('<img src="'+t+'">')},initIframe:function(){var t="upload-iframe-"+(new Date).getTime(),e=$("<iframe>").attr({name:t,src:""}),i=this;e.one("load",function(){e.on("load",function(){var t;try{t=$(this).contents().find("body").text()}catch(e){}if(t){try{t=$.parseJSON(t)}catch(e){}i.submitDone(t,!0)}else i.submitFail("Image upload failed!");i.submitEnd()})}),this.$iframe=e,this.$cropperImageForm.attr("target",t).after(e.hide())},click:function(){this.$cropperImageModal.modal("show"),this.initPreview()},change:function(){var t,e;this.support.datauri?(t=this.$cropperImageInput.prop("files"),t.length>0&&(e=t[0],this.isImageFile(e)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(e),this.startCropper()))):(e=this.$cropperImageInput.val(),this.isImageFile(e)&&this.syncUpload())},submit:function(){return!(!this.$cropperImageSrc.val()&&!this.$cropperImageInput.val())&&(!!this.support.formData&&(this.ajaxUpload(),!1))},rotate:function(t){var e;this.active&&(e=$(t.target).data(),e.method&&this.$img.cropper(e.method,e.option))},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png|gif)$/.test(t)},startCropper:function(){var t=this;this.active?this.$img.cropper("replace",this.url):(this.$img=$('<img src="'+this.url+'">'),this.$cropperImageWrapper.empty().html(this.$img),this.$img.cropper({viewMode:1,aspectRatio:this.aspectRatio,preview:this.$cropperImagePreview.selector,crop:function(e){var i=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join();t.$cropperImageData.val(i)}}),this.active=!0),this.$cropperImageModal.one("hidden.bs.modal",function(){t.$cropperImagePreview.empty(),t.stopCropper()})},stopCropper:function(){this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},ajaxUpload:function(){var t=this,e=new FormData(t.$cropperImageForm[0]),i=new KatnissApi;i.request(t.postUrl,i.REQUEST_TYPE_POST,e,{beforeSend:function(){t.submitStart()},success:function(e){t.submitDone(e,!1)},error:function(e,i,r){t.submitFail(i||r)},complete:function(){t.submitEnd()}})},syncUpload:function(){this.$cropperImageSave.click()},submitStart:function(){this.$loading.fadeIn()},submitDone:function(t,e){e?$.isPlainObject(data)&&200===data.state?data.result?(this.url=data.result,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$avatarSrc.val(this.url),this.startCropper()),this.$avatarInput.val("")):data.message&&this.alert(data.message):this.alert("Failed to response"):t._success?(this.url=t._data.store_path,this.support.datauri||this.uploaded?(this.uploaded=!1,this.cropDone()):(this.uploaded=!0,this.$cropperImageSrc.val(this.url),this.startCropper()),this.$cropperImageInput.val("")):t._messages&&this.alert(t._messages)},submitFail:function(t){this.alert(t)},submitEnd:function(){this.$loading.fadeOut()},cropDone:function(){this.$cropperImageForm.get(0).reset(),this.$cropperImage.attr("src",this.url),this.stopCropper(),this.$cropperImageModal.modal("hide")},alert:function(t){"string"==typeof t&&(t=[t]);var e=['<div class="alert alert-danger cropper-image-alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert">&times;</button>',t.join("<br>"),"</div>"].join("");this.$cropperImageUpload.after(e)}};